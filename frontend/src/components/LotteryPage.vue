<!-- ‰ª£Á†ÅÂ∑≤ÂåÖÂê´ CSSÔºö‰ΩøÁî® TailwindCSS , ÂÆâË£Ö TailwindCSS ÂêéÊñπÂèØÁúãÂà∞Â∏ÉÂ±ÄÊ†∑ÂºèÊïàÊûú -->
<template>
  <div class="min-h-screen bg-red-600 flex items-center justify-center py-6"
    :style="{ backgroundImage: `url(${backgroundImage})`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' }">
    <!-- ÂèØÁºñËæëÊ†áÈ¢ò -->
    <div class="fixed top-2 left-4 z-10">
      <div v-if="!isEditing" @dblclick="startEdit"
        class="text-white font-bold cursor-pointer hover:text-yellow-400 transition-colors duration-200 bg-transparent px-3 py-2 rounded"
        style="font-size: 25px;">
        {{ organizationName }}
      </div>
      <input v-else ref="editInput" v-model="organizationName" @blur="stopEdit" @keyup.enter="stopEdit"
        class="text-white font-bold  outline-none" style="font-size: 25px;" type="text">
    </div>
    <div class="w-[1440px] max-w-full relative">
      <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
      <div class="max-w-[1200px] mx-auto mt-0 rounded-lg p-8">


        <!-- Â•ñÈ°πÂ±ïÁ§∫ -->
        <div class="flex flex-col items-center">
          <!-- Â•ñÈ°π‰ø°ÊÅØÂÆπÂô® -->
          <div class="flex flex-col items-center rounded-xl w-full relative">
            <div
              class="w-[300px] h-[300px] bg-gradient-to-br from-red-500 via-red-600 to-red-700 border-2 border-yellow-400 shadow-xl rounded-lg p-4 mb-4 backdrop-blur-sm transition-all duration-1000 transform-gpu"
              :class="{ 'scale-0 opacity-0': showWinnerNames }">
              <img :src="currentAward.image" :alt="currentAward.description"
                class="w-full h-full object-contain transition-all duration-1000 transform-gpu"
                :class="{ 'scale-0 opacity-0': showWinnerNames }">
            </div>

            <!-- items-center: ÈªòËÆ§ÊòæÁ§∫ÁöÑÂ•ñÈ°π‰ø°ÊÅØ -->
            <div class="items-center transition-all duration-1000 transform-gpu"
              :class="{ 'scale-0 opacity-0': showWinnerNames }">
              <!-- <h2 class="text-yellow-400 text-xl font-bold mb-2 text-center transition-all duration-1000 transform-gpu"
                :class="{ 'scale-0 opacity-0': showWinnerNames }">{{ currentAward.name }}</h2> -->
              <p class="text-white text-base mb-4 text-center transition-all duration-1000 transform-gpu"
                :class="{ 'scale-0 opacity-0': showWinnerNames }">{{ currentAward.description }}</p>
            </div>

            <!-- items-name: ÊäΩÂ•ñÊó∂ÊòæÁ§∫ÁöÑÂèÇ‰∏éËÄÖÂßìÂêç -->
            <div
              class="items-name absolute inset-0 w-full h-full flex items-center justify-center transition-all duration-700 ease-in-out bg-gradient-to-br from-red-600/90 via-red-700/95 to-red-800/90 backdrop-blur-sm transform-gpu will-change-transform shadow-inner border-4 border-yellow-400/60"
              :class="{ 'opacity-100 visible scale-100 translate-y-0': showWinnerNames, 'opacity-0 invisible scale-95 translate-y-2': !showWinnerNames }"
              :style="{ borderImageSource: `url(${cjbgImage})` }">
              <div class="w-full h-full flex items-center justify-center p-0">
                <!-- ÊäΩÂ•ñ‰∏≠ÊòæÁ§∫ÊªöÂä®ÁöÑ‰∫∫ÂêçÔºåÊäΩÂ•ñÁªìÊùüÊòæÁ§∫‰∏≠Â•ñËÄÖ -->
                <div class="grid gap-6 w-full h-full place-items-center place-content-center" :class="{
                  'grid-cols-1': (isDrawing ? drawCount : currentWinners.length) <= 1,
                  'grid-cols-2': (isDrawing ? drawCount : currentWinners.length) === 2,
                  'grid-cols-3': (isDrawing ? drawCount : currentWinners.length) >= 3 && (isDrawing ? drawCount : currentWinners.length) <= 6,
                  'grid-cols-4': (isDrawing ? drawCount : currentWinners.length) > 6
                }">
                  <!-- ÊäΩÂ•ñ‰∏≠ÊòæÁ§∫ÊªöÂä®‰∫∫Âêç -->
                  <template v-if="isDrawing">
                    <div v-for="index in drawCount" :key="index"
                      class="text-yellow-300 text-4xl font-bold transition-all duration-300 drop-shadow-lg">
                      {{ rollingNames[index - 1] || 'ÂèÇ‰∏éËÄÖ' }}
                    </div>

                  </template>
                  <!-- ÊäΩÂ•ñÁªìÊùüÊòæÁ§∫‰∏≠Â•ñËÄÖ -->
                  <template v-else-if="currentWinners.length > 0">
                    <div v-for="(winner, index) in currentWinners" :key="index"
                      class="text-yellow-400 text-4xl font-bold">
                      {{ winner.name }}
                    </div>
                  </template>
                </div>
              </div>
            </div>

          </div>
          <!-- ÊéßÂà∂Èù¢Êùø -->
          <div
            class="mt-4 flex items-center justify-center gap-4 bg-gradient-to-r from-red-700/20 to-yellow-600/20 border border-yellow-400/30 p-4 rounded-lg max-w-4xl mx-auto backdrop-blur-sm">
            <!-- Êï∞ÈáèÊéßÂà∂ -->
            <div class="flex items-center gap-2">
              <el-input-number v-model="drawCount" :min="1" :max="currentAward.count || 10"
                class="!rounded-button custom-input-number" @change="updateDrawCount" />
            </div>
            <!-- Â•ñÈ°πÈÄâÊã© -->
            <div class="flex items-center gap-2">
              <el-button :icon="ArrowLeft" type="default"
                class="!rounded-button !bg-yellow-500/20 !border-yellow-400 !text-yellow-300 hover:!bg-yellow-500/30 hover:!text-yellow-200"
                :disabled="currentIndex === 0" @click="selectAward(currentIndex - 1)">
              </el-button>
              <span class="text-yellow-300 text-lg px-3 font-semibold">{{ currentAward.name }}</span>
              <el-button :icon="ArrowRight" type="default"
                class="!rounded-button !bg-yellow-500/20 !border-yellow-400 !text-yellow-300 hover:!bg-yellow-500/30 hover:!text-yellow-200"
                :disabled="currentIndex === awards.length - 1" @click="selectAward(currentIndex + 1)">
              </el-button>
            </div>



            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="flex gap-2">
              <el-button type="success" :disabled="isDrawing || remainingCount === 0"
                class="!rounded-button whitespace-nowrap !bg-gradient-to-r !from-red-600 !to-red-700 !border-red-600 hover:!from-red-700 hover:!to-red-800 !text-yellow-100 !font-semibold"
                @click="startDraw">
                {{ isDrawing ? 'ÊäΩÂ•ñ‰∏≠...' : 'ÂºÄÂßãÊäΩÂ•ñ' }}
              </el-button>
              <!-- <el-button type="danger" :disabled="!isDrawing || isSlowingDown"
                class="!rounded-button whitespace-nowrap !bg-gradient-to-r !from-orange-500 !to-orange-600 !border-orange-500 hover:!from-orange-600 hover:!to-orange-700 !text-white !font-semibold"
                @click="stopDraw">
                ÂÅúÊ≠¢ÊäΩÂ•ñ
              </el-button> -->
              <el-button type="warning"
                class="!rounded-button whitespace-nowrap !bg-gradient-to-r !from-yellow-500 !to-yellow-600 !border-yellow-500 hover:!from-yellow-600 hover:!to-yellow-700 !text-red-800 !font-semibold"
                @click="showWinners">
                ‰∏≠Â•ñÂêçÂçï
              </el-button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‰∏ã‰∏ÄËΩÆÊåâÈíÆ -->
      <div class="fixed bottom-4 right-4">
        <el-button type="primary" size="medium"
          class="!rounded-button !bg-gradient-to-r !from-yellow-500 !to-yellow-600 !border-yellow-500 hover:!from-yellow-600 hover:!to-yellow-700 !text-red-800 !font-bold !shadow-lg"
          @click="nextRound">
          ‰∏ã‰∏ÄËΩÆ
          <span style="font-size: 12px;">(ÂΩìÂâçÁ¨¨{{ currentEpoch}}ËΩÆ)</span>
        </el-button>
      </div>
    </div>

    <!-- ‰∏≠Â•ñÂêçÂçïÂØπËØùÊ°Ü -->
    <el-dialog v-model="dialogVisible" title="‰∏≠Â•ñÂêçÂçï" width="30%">
      <el-table :data="winners" style="width: 100%">
        <el-table-column prop="name" label="ÂßìÂêç" />
        <el-table-column prop="award" label="Â•ñÈ°π" />
      </el-table>
    </el-dialog>

    <!-- ÈÜíÁõÆÁöÑ‰∏≠Â•ñÂºπÁ™ó -->
    <div v-if="showWinnerDialog"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4"
      @click="closeWinnerDialog">
      <div
        class="relative bg-gradient-to-br from-red-600 via-red-700 to-red-800 rounded-3xl p-8 shadow-2xl max-h-[90vh] overflow-y-auto"
        :class="{
          'w-full max-w-md': currentWinners.length <= 1,
          'w-full max-w-2xl': currentWinners.length === 2,
          'w-full max-w-4xl': currentWinners.length >= 3 && currentWinners.length <= 6,
          'w-full max-w-6xl': currentWinners.length > 6 && currentWinners.length <= 12,
          'w-full max-w-7xl': currentWinners.length > 12
        }"
        @click.stop>
        <!-- Ë£ÖÈ•∞ÊÄßËæπÊ°Ü -->
        <div class="absolute inset-0 rounded-3xl border-4 border-yellow-400 opacity-75"></div>
        <div class="absolute inset-2 rounded-2xl border-2 border-yellow-300"></div>

        <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
        <button @click="closeWinnerDialog"
          class="absolute top-4 right-4 text-yellow-300 hover:text-yellow-100 text-2xl font-bold z-10">
          √ó
        </button>

        <!-- Ê†áÈ¢ò -->
        <div class="text-center mb-8 relative z-10">
          <h1 class="text-6xl font-bold text-yellow-300 mb-4">
            üéâ ÊÅ≠Âñú‰∏≠Â•ñ üéâ
          </h1>
          <div class="text-2xl text-yellow-200 font-semibold">
            {{ currentAward.name }}
          </div>
        </div>

        <!-- ‰∏≠Â•ñËÄÖÂàóË°® -->
        <div class="relative z-10">
          <div class="grid gap-4 place-items-center justify-items-center" :class="{
            'grid-cols-1': currentWinners.length <= 1,
            'grid-cols-2': currentWinners.length === 2,
            'grid-cols-3': currentWinners.length >= 3 && currentWinners.length <= 6,
            'grid-cols-4': currentWinners.length > 6 && currentWinners.length <= 12,
            'grid-cols-5': currentWinners.length > 12 && currentWinners.length <= 20,
            'grid-cols-6': currentWinners.length > 20
          }">
            <div v-for="(winner, index) in currentWinners" :key="index"
              class="bg-yellow-400 text-red-800 px-4 py-3 rounded-2xl shadow-lg text-center w-full"
              :class="{
                'min-w-[200px] max-w-[280px]': currentWinners.length <= 6,
                'min-w-[160px] max-w-[200px]': currentWinners.length > 6 && currentWinners.length <= 12,
                'min-w-[140px] max-w-[160px]': currentWinners.length > 12 && currentWinners.length <= 20,
                'min-w-[120px] max-w-[140px]': currentWinners.length > 20
              }">
              <div class="font-bold mb-1 break-words"
                :class="{
                  'text-3xl': currentWinners.length <= 6,
                  'text-2xl': currentWinners.length > 6 && currentWinners.length <= 12,
                  'text-xl': currentWinners.length > 12 && currentWinners.length <= 20,
                  'text-lg': currentWinners.length > 20
                }">{{ winner.name }}</div>
              <div class="text-red-600 break-words"
                :class="{
                  'text-lg': currentWinners.length <= 6,
                  'text-base': currentWinners.length > 6 && currentWinners.length <= 12,
                  'text-sm': currentWinners.length > 12 && currentWinners.length <= 20,
                  'text-xs': currentWinners.length > 20
                }">{{ winner.department || 'Êú™Áü•ÈÉ®Èó®' }}</div>
            </div>
          </div>
        </div>
        <!-- ËÉåÊôØË£ÖÈ•∞ -->
        <div class="absolute inset-0 overflow-hidden rounded-3xl">
          <div class="absolute -top-10 -left-10 w-20 h-20 bg-yellow-400 rounded-full opacity-20"></div>
          <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-yellow-300 rounded-full opacity-10"></div>
          <div class="absolute top-1/2 left-10 w-16 h-16 bg-yellow-500 rounded-full opacity-15"></div>
          <div class="absolute top-20 right-20 w-12 h-12 bg-yellow-400 rounded-full opacity-25"></div>
        </div>
      </div>
    </div>
    
    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <BottomNavigation />
  </div>
</template>

<script setup>
import { ref, computed, onUnmounted, onMounted, nextTick } from 'vue';
import { ArrowLeft, ArrowRight } from '@element-plus/icons-vue';
import { ElMessage } from 'element-plus';
import { awardAPI, lotteryAPI, participantAPI } from '../api/index.js';
import BottomNavigation from './BottomNavigation.vue';

// Èü≥È¢ëÊñá‰ª∂ÂºïÁî®
const processAudio = new Audio(new URL('../assets/sound/process.wav', import.meta.url).href);
const endAudio = new Audio(new URL('../assets/sound/end.wav', import.meta.url).href);

// ËÆæÁΩÆÈü≥È¢ëÂ±ûÊÄß
processAudio.loop = true; // ÊäΩÂ•ñËøáÁ®ãÈü≥‰πêÂæ™ÁéØÊí≠Êîæ
processAudio.volume = 0.6; // ËÆæÁΩÆÈü≥Èáè
endAudio.volume = 0.8; // ËÆæÁΩÆÈü≥Èáè

// ÂèØÁºñËæëÁªÑÁªáÂêçÁß∞
const organizationName = ref('Â±±Ë•øÁúÅËÆ°ÁÆóÊú∫ËΩØ‰ª∂Â≠¶‰ºö');
const isEditing = ref(false);
const editInput = ref(null);

// ÂºÄÂßãÁºñËæë
const startEdit = () => {
  isEditing.value = true;
  nextTick(() => {
    editInput.value?.focus();
    editInput.value?.select();
  });
};

// ÂÅúÊ≠¢ÁºñËæë
const stopEdit = () => {
  isEditing.value = false;
};

// Â•ñÈ°πÊï∞ÊçÆ‰ªéÊï∞ÊçÆÂ∫ìËé∑Âèñ
const awards = ref([]);
const awardsLoading = ref(false);

// ËΩÆÊ¨°‰ø°ÊÅØ
const currentEpoch = ref(1);
const epochStatus = ref(1);

// Á≥ªÁªüÈÖçÁΩÆ
const systemConfig = ref({
  winnerDisplayDelay: 500 // ÈªòËÆ§ÂÄº
});

// Ëé∑ÂèñÂ•ñÈ°πÊï∞ÊçÆ
const fetchAwards = async () => {
  try {
    awardsLoading.value = true;
    const data = await awardAPI.getConfig();
    // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºèÂπ∂ÁîüÊàêÂõæÁâáË∑ØÂæÑ
    awards.value = data.map(award => ({
      id: award.id,
      level: award.level,
      name: award.name,
      description: award.description,
      count: award.total_count,
      remaining_count: award.remaining_count,
      draw_count: award.draw_count || 1,
      image: new URL(`../assets/award/${award.name}.png`, import.meta.url).href
    }));

    console.log('awards', awards.value);
    // Â¶ÇÊûúÊúâÂ•ñÈ°πÊï∞ÊçÆÔºåËÆæÁΩÆÂΩìÂâçÂ•ñÈ°π
    if (awards.value.length > 0) {
      currentAward.value = awards.value[0];
      // ÂêåÊ≠•ÂàùÂßãÂåñÊäΩÂèñÊï∞Èáè
      drawCount.value = currentAward.value?.draw_count || 1;
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂ•ñÈ°πÊï∞ÊçÆÂ§±Ë¥•:', error);
    // Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
    awards.value = [
      {
        id: 1,
        level: 1,
        name: '‰∏ÄÁ≠âÂ•ñ',
        description: 'Â∞èÂ§©ÈπÖÊ¥óË°£Êú∫',
        count: 50,
        remaining_count: 50,
        draw_count: 5,
        image: new URL('../assets/award/‰∏ÄÁ≠âÂ•ñ.png', import.meta.url).href
      },
      {
        id: 2,
        level: 2,
        name: '‰∫åÁ≠âÂ•ñ',
        description: 'Êà¥Ê£ÆÂêπÈ£éÊú∫',
        count: 100,
        remaining_count: 100,
        draw_count: 10,
        image: new URL('../assets/award/‰∫åÁ≠âÂ•ñ.png', import.meta.url).href
      },
      {
        id: 3,
        level: 3,
        name: '‰∏âÁ≠âÂ•ñ',
        description: 'Êô∫ËÉΩËøêÂä®ÊâãË°®ÔºåÂÅ•Â∫∑ÁîüÊ¥ª‰º¥‰æ£',
        count: 150,
        remaining_count: 150,
        draw_count: 15,
        image: new URL('../assets/award/‰∏âÁ≠âÂ•ñ.png', import.meta.url).href
      }
    ];
    currentAward.value = awards.value[0];
    // ÂêåÊ≠•ÂàùÂßãÂåñÊäΩÂèñÊï∞Èáè
    drawCount.value = currentAward.value?.draw_count || 1;
  } finally {
    awardsLoading.value = false;
  }
};

// Ëé∑ÂèñÁ≥ªÁªüÈÖçÁΩÆ
const fetchSystemConfig = async () => {
  try {
    const response = await fetch('/api/lottery/system-config');
    
    // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
    if (!response.ok) {
      console.warn(`APIÂìçÂ∫îÁä∂ÊÄÅ: ${response.status}`);
      systemConfig.value = { winnerDisplayDelay: 500 };
      return;
    }
    
    // Ê£ÄÊü•ÂìçÂ∫îÂÜÖÂÆπÁ±ªÂûã
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      console.warn('APIÂìçÂ∫î‰∏çÊòØJSONÊ†ºÂºè');
      systemConfig.value = { winnerDisplayDelay: 500 };
      return;
    }
    
    const text = await response.text();
    if (!text.trim()) {
      console.warn('APIÂìçÂ∫î‰∏∫Á©∫');
      systemConfig.value = { winnerDisplayDelay: 500 };
      return;
    }
    
    const data = JSON.parse(text);
    if (data.success && data.config) {
      systemConfig.value = {
        winnerDisplayDelay: data.config.winnerDisplayDelay || 500
      };
    } else {
      systemConfig.value = { winnerDisplayDelay: 500 };
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÁ≥ªÁªüÈÖçÁΩÆÂ§±Ë¥•:', error);
    // ‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ
    systemConfig.value = {
      winnerDisplayDelay: 500
    };
  }
};

const currentIndex = ref(0);
const currentAward = ref({});
const dialogVisible = ref(false);
const isDrawing = ref(false);
// ÊäΩÂèñÊï∞Èáè‰ΩøÁî®refÔºå‰∏écurrentAward.draw_countÂêåÊ≠•
const drawCount = ref(1);
// Ââ©‰ΩôÊï∞ÈáèÂü∫‰∫éÂΩìÂâçÂ•ñÈ°πÁöÑremaining_count
const remainingCount = computed(() => {
  return currentAward.value?.remaining_count || 0;
});
const showWinnerNames = ref(false);
const currentWinners = ref([]);
const rollingNames = ref([]);
const rollingTimer = ref(null);
const showWinnerDialog = ref(false);
const isSlowingDown = ref(false);
const slowDownStartTime = ref(0);
// ÂáèÈÄüÊó∂Èó¥Ê†πÊçÆÈÖçÁΩÆÂä®ÊÄÅËÆ°ÁÆó
const getSlowDownDuration = () => {
  // Â¶ÇÊûúËÆæÁΩÆ‰∏∫Á´ãÂç≥ÊòæÁ§∫ÔºåÂàôÁ´ãÂç≥ÂÅúÊ≠¢Ôºà100msÊúÄÂ∞èÂáèÈÄüÊó∂Èó¥Ôºâ
  if (systemConfig.value.winnerDisplayDelay === 0) {
    return 100;
  }
  // Âê¶Âàô‰ΩøÁî®ÈÖçÁΩÆÁöÑÂª∂ËøüÊó∂Èó¥‰Ωú‰∏∫ÂáèÈÄüÊó∂Èó¥
  return systemConfig.value.winnerDisplayDelay;
};
// ËÉåÊôØÂõæÁâá
const backgroundImage = new URL('../assets/background/c.png', import.meta.url).href;

// ÂèÇ‰∏éËÄÖÊï∞ÊçÆ‰ªéAPIËé∑Âèñ
const participants = ref([]);
const participantsLoading = ref(false);

// Ëé∑ÂèñÂèÇ‰∏éËÄÖÂÆåÊï¥‰ø°ÊÅØÂàóË°®
const fetchParticipants = async () => {
  try {
    participantsLoading.value = true;
    const participantData = await participantAPI.getAvailable();
    participants.value = participantData;
  } catch (error) {
    console.error('Ëé∑ÂèñÂèÇ‰∏éËÄÖÂàóË°®Â§±Ë¥•:', error);
    ElMessage.error('Ëé∑ÂèñÂèÇ‰∏éËÄÖÂàóË°®Â§±Ë¥•');
    // Â¶ÇÊûúAPIÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®Êï∞ÊçÆ
    participants.value = [
      { name: 'Âº†Èõ®Êô®', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ÊùéÊÄùÊàê', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ÁéãÊ¢ìËê±', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ÈôàÂÆáËà™', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ÂàòÊ¨£ÊÄ°', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ÈªÑÂ≠êË±™', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'Âë®ÁæéÁé≤', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'Âê¥ÊâøÁø∞', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'ËµµÈõÖÂ©∑', department: 'ÊäÄÊúØÈÉ®' },
      { name: 'Â≠ôÊµ©ÁÑ∂', department: 'ÊäÄÊúØÈÉ®' }
    ];
  } finally {
    participantsLoading.value = false;
  }
};

// Ëé∑ÂèñÊäΩÂ•ñÁä∂ÊÄÅÂíåËΩÆÊ¨°‰ø°ÊÅØ
const fetchLotteryStatus = async () => {
  try {
    const statusData = await lotteryAPI.getStatus();
    currentEpoch.value = statusData.currentEpoch || 0;
    epochStatus.value = statusData.epochStatus || 1;
  } catch (error) {
    console.error('Ëé∑ÂèñÊäΩÂ•ñÁä∂ÊÄÅÂ§±Ë¥•:', error);
    // ‰ΩøÁî®ÈªòËÆ§ÂÄº
    currentEpoch.value = 0;
    epochStatus.value = 1;
  }
};

const winners = ref([]);

// Ë∞ÉÁî®ÂêéÁ´ØAPIÊâßË°åÊäΩÂ•ñ
const drawWinners = async () => {
  try {
    const drawData = {
      awardId: currentAward.value.id,
      count: drawCount.value
    };
    
    const result = await lotteryAPI.draw(drawData);
    
    if (result.success) {
      // Êõ¥Êñ∞‰∏≠Â•ñËÄÖÂàóË°®
      const newWinners = result.winners.map(winner => ({
        id: winner.id,
        name: winner.participant.name,
        department: winner.participant.department,
        award: winner.award,
        draw_time: winner.draw_time
      }));
      
      winners.value = [...winners.value, ...newWinners];
      
      // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ•ñÈ°πÁ¥¢Âºï
      const savedIndex = currentIndex.value;
      const savedAwardId = currentAward.value.id;
      
      // ÈáçÊñ∞Ëé∑ÂèñÂ•ñÈ°πÊï∞ÊçÆ‰ª•Êõ¥Êñ∞Ââ©‰ΩôÊï∞Èáè
      await fetchAwards();
      
      // ÊÅ¢Â§ç‰πãÂâçÈÄâ‰∏≠ÁöÑÂ•ñÈ°π
      if (savedIndex >= 0 && savedIndex < awards.value.length) {
        currentIndex.value = savedIndex;
        currentAward.value = awards.value[savedIndex];
        drawCount.value = currentAward.value?.draw_count || 1;
      } else {
        // Â¶ÇÊûúÁ¥¢ÂºïÊó†ÊïàÔºåÂ∞ùËØïÈÄöËøáIDÊâæÂà∞ÂØπÂ∫îÁöÑÂ•ñÈ°π
        const foundIndex = awards.value.findIndex(award => award.id === savedAwardId);
        if (foundIndex !== -1) {
          currentIndex.value = foundIndex;
          currentAward.value = awards.value[foundIndex];
          drawCount.value = currentAward.value?.draw_count || 1;
        }
      }
      
      return newWinners;
    } else {
      ElMessage.error(result.error || 'ÊäΩÂ•ñÂ§±Ë¥•');
      return [];
    }
  } catch (error) {
    console.error('ÊäΩÂ•ñÂ§±Ë¥•:', error);
    ElMessage.error('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    return [];
  }
};

const selectAward = (index) => {
  currentIndex.value = index;
  currentAward.value = awards.value[index];
  // ÂêåÊ≠•Êõ¥Êñ∞ÊäΩÂèñÊï∞Èáè
  drawCount.value = currentAward.value?.draw_count || 1;
};

// Êõ¥Êñ∞ÊäΩÂèñÊï∞Èáè
const updateDrawCount = async (newValue) => {
  if (!currentAward.value || !newValue) return;
  
  try {
    // È™åËØÅÊï∞ÈáèËåÉÂõ¥
    if (newValue < 1 || newValue > currentAward.value.count) {
      ElMessage.error(`ÊäΩÂèñÊï∞ÈáèÂøÖÈ°ªÂú®1Âà∞${currentAward.value.count}‰πãÈó¥`);
      return;
    }
    console.log('currentAward', currentAward);
    // Ë∞ÉÁî®ÂêéÁ´ØAPIÊõ¥Êñ∞Â•ñÈ°πÁöÑdraw_count
    const updateData = {
      level: currentAward.value.level,
      name: currentAward.value.name,
      description: currentAward.value.description,
      count: currentAward.value.count,
      draw_count: newValue
    };
    
    await awardAPI.update(currentAward.value.id, updateData);
    
    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
    currentAward.value.draw_count = newValue;
    
    // ÂêåÊ≠•Êõ¥Êñ∞awardsÊï∞ÁªÑ‰∏≠ÁöÑÊï∞ÊçÆ
    const awardIndex = awards.value.findIndex(award => award.id === currentAward.value.id);
    if (awardIndex !== -1) {
      awards.value[awardIndex].draw_count = newValue;
    }
    
    console.log(`Â•ñÈ°π ${currentAward.value.name} ÁöÑÊäΩÂèñÊï∞ÈáèÂ∑≤Êõ¥Êñ∞‰∏∫ ${newValue}`);
  } catch (error) {
    console.error('Êõ¥Êñ∞ÊäΩÂèñÊï∞ÈáèÂ§±Ë¥•:', error);
    ElMessage.error('Êõ¥Êñ∞ÊäΩÂèñÊï∞ÈáèÂ§±Ë¥•');
    // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ‰ª•ÊÅ¢Â§çÊ≠£Á°ÆÁä∂ÊÄÅ
    await fetchAwards();
  }
};

const startDraw = () => {
  if (isDrawing.value || remainingCount.value === 0) return;

  isDrawing.value = true;
  isSlowingDown.value = false;
  showWinnerNames.value = true;
  currentWinners.value = [];

  // Êí≠ÊîæÊäΩÂ•ñËøáÁ®ãÈü≥‰πê
  try {
    processAudio.currentTime = 0; // ÈáçÁΩÆÊí≠Êîæ‰ΩçÁΩÆ
    processAudio.play().catch(error => {
      console.warn('Êí≠ÊîæÊäΩÂ•ñÈü≥‰πêÂ§±Ë¥•:', error);
    });
  } catch (error) {
    console.warn('Êí≠ÊîæÊäΩÂ•ñÈü≥‰πêÂ§±Ë¥•:', error);
  }

  // ÂàùÂßãÂåñÊªöÂä®‰∫∫ÂêçÊï∞ÁªÑ
  rollingNames.value = new Array(drawCount.value).fill('');

  // ÂºÄÂßã‰∫∫ÂêçÊªöÂä®
  startRolling();

  // Ê∑ªÂä†ÈîÆÁõòÁõëÂê¨
  document.addEventListener('keydown', handleKeyPress);
};

// ÂºÄÂßã‰∫∫ÂêçÊªöÂä®
const startRolling = () => {
  const updateNames = () => {
    const availableParticipants = participants.value.filter(
      p => !winners.value.some(w => w.name === p.name)
    );

    for (let i = 0; i < drawCount.value; i++) {
      const randomIndex = Math.floor(Math.random() * availableParticipants.length);
      rollingNames.value[i] = availableParticipants[randomIndex]?.name || 'ÂèÇ‰∏éËÄÖ';
    }
  };

  const roll = () => {
    if (!isDrawing.value) return;
    
    updateNames();
    
    let interval = 100; // ÂàùÂßãÈó¥Èöî100msÔºåÊªöÂä®ÂæàÂø´
    
    if (isSlowingDown.value) {
      // ËÆ°ÁÆóÂáèÈÄüËøõÂ∫¶ (0-1)
      const elapsed = Date.now() - slowDownStartTime.value;
      const progress = Math.min(elapsed / getSlowDownDuration(), 1);
      
      // ‰ΩøÁî®ÁºìÂä®ÂáΩÊï∞ÂÆûÁé∞Âπ≥ÊªëÂáèÈÄü
      const easeOut = 1 - Math.pow(1 - progress, 3);
      interval = 100 + (1500 * easeOut); // ‰ªé100msÈÄêÊ∏êÂ¢ûÂä†Âà∞1600ms
      
      if (progress >= 1) {
        // ÂáèÈÄüÂÆåÊàêÔºåÂÅúÊ≠¢ÊäΩÂ•ñ
        finalizeDraw();
        return;
      }
    }
    
    rollingTimer.value = setTimeout(roll, interval);
  };
  
  roll();
};

// ÂºÄÂßãÂáèÈÄüÂÅúÊ≠¢ÊäΩÂ•ñ
const stopDraw = () => {
  if (!isDrawing.value || isSlowingDown.value) return;

  // ÂºÄÂßãÂáèÈÄüËøáÁ®ã
  isSlowingDown.value = true;
  slowDownStartTime.value = Date.now();
};

// ÊúÄÁªàÁ°ÆÂÆö‰∏≠Â•ñËÄÖ
const finalizeDraw = async () => {
  // ÂÅúÊ≠¢ÊäΩÂ•ñËøáÁ®ãÈü≥‰πê
  try {
    processAudio.pause();
    processAudio.currentTime = 0;
  } catch (error) {
    console.warn('ÂÅúÊ≠¢ÊäΩÂ•ñÈü≥‰πêÂ§±Ë¥•:', error);
  }

  // Ê∏ÖÈô§ÂÆöÊó∂Âô®
  if (rollingTimer.value) {
    clearTimeout(rollingTimer.value);
    rollingTimer.value = null;
  }

  // ÁßªÈô§ÈîÆÁõòÁõëÂê¨
  document.removeEventListener('keydown', handleKeyPress);

  try {
    // Á°ÆÂÆöÊúÄÁªà‰∏≠Â•ñËÄÖ
    const newWinners = await drawWinners();
    
    if (newWinners && newWinners.length > 0) {
      // Êí≠ÊîæÁªìÊùüÈü≥‰πê
      try {
        endAudio.currentTime = 0; // ÈáçÁΩÆÊí≠Êîæ‰ΩçÁΩÆ
        endAudio.play().catch(error => {
          console.warn('Êí≠ÊîæÁªìÊùüÈü≥‰πêÂ§±Ë¥•:', error);
        });
      } catch (error) {
        console.warn('Êí≠ÊîæÁªìÊùüÈü≥‰πêÂ§±Ë¥•:', error);
      }

      // Êõ¥Êñ∞ÂΩìÂâç‰∏≠Â•ñËÄÖÂàóË°®
      currentWinners.value = newWinners;
      
      // ÊòæÁ§∫‰∏≠Â•ñÂºπÁ™ó
      // Â¶ÇÊûúËÆæÁΩÆ‰∏∫Á´ãÂç≥ÊòæÁ§∫ÔºåÂàô‰∏çÂÜçÊúâÈ¢ùÂ§ñÂª∂ËøüÔºàÂõ†‰∏∫ÂáèÈÄüÊó∂Èó¥Â∑≤ÁªèÂåÖÂê´‰∫ÜÂª∂ËøüÔºâ
      if (systemConfig.value.winnerDisplayDelay === 0) {
        showWinnerDialog.value = true;
      } else {
        // ÂØπ‰∫éÈùûÁ´ãÂç≥ÊòæÁ§∫ÔºåÂáèÈÄüÊó∂Èó¥Â∞±ÊòØÂª∂ËøüÊó∂Èó¥ÔºåÊâÄ‰ª•Á´ãÂç≥ÊòæÁ§∫
        showWinnerDialog.value = true;
      }
    } else {
      ElMessage.error('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  } catch (error) {
    console.error('ÊäΩÂ•ñÂ§±Ë¥•:', error);
    ElMessage.error('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
  } finally {
    // ÈáçÁΩÆÁä∂ÊÄÅ
    isDrawing.value = false;
    isSlowingDown.value = false;
  }
};

// ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
const handleKeyPress = (event) => {
  if (event.code === 'Space') {
    event.preventDefault();
    // Á´ãÂç≥ÂÅúÊ≠¢ÊäΩÂ•ñÂπ∂ÊòæÁ§∫‰∏≠Â•ñËÄÖ
    immediateStop();
  }
};

// Á´ãÂç≥ÂÅúÊ≠¢ÊäΩÂ•ñ
const immediateStop = async () => {
  if (!isDrawing.value) return;

  // Á´ãÂç≥ÂÅúÊ≠¢ÊªöÂä®
  if (rollingTimer.value) {
    clearTimeout(rollingTimer.value);
    rollingTimer.value = null;
  }

  // ÂÅúÊ≠¢ÊäΩÂ•ñËøáÁ®ãÈü≥‰πê
  try {
    processAudio.pause();
    processAudio.currentTime = 0;
  } catch (error) {
    console.warn('ÂÅúÊ≠¢ÊäΩÂ•ñÈü≥‰πêÂ§±Ë¥•:', error);
  }

  // ÁßªÈô§ÈîÆÁõòÁõëÂê¨
  document.removeEventListener('keydown', handleKeyPress);

  try {
    // Á°ÆÂÆöÊúÄÁªà‰∏≠Â•ñËÄÖ
    const newWinners = await drawWinners();
    
    if (newWinners && newWinners.length > 0) {
      // Êí≠ÊîæÁªìÊùüÈü≥‰πê
      try {
        endAudio.currentTime = 0;
        endAudio.play().catch(error => {
          console.warn('Êí≠ÊîæÁªìÊùüÈü≥‰πêÂ§±Ë¥•:', error);
        });
      } catch (error) {
        console.warn('Êí≠ÊîæÁªìÊùüÈü≥‰πêÂ§±Ë¥•:', error);
      }

      // Êõ¥Êñ∞ÂΩìÂâç‰∏≠Â•ñËÄÖÂàóË°®
      currentWinners.value = newWinners;
      
      // Á´ãÂç≥ÊòæÁ§∫‰∏≠Â•ñÂºπÁ™ó
      showWinnerDialog.value = true;
    } else {
      ElMessage.error('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  } catch (error) {
    console.error('ÊäΩÂ•ñÂ§±Ë¥•:', error);
    ElMessage.error('ÊäΩÂ•ñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
  } finally {
    // ÈáçÁΩÆÁä∂ÊÄÅ
    isDrawing.value = false;
    isSlowingDown.value = false;
  }
};

// ÂÖ≥Èó≠‰∏≠Â•ñÂºπÁ™ó
const closeWinnerDialog = () => {
  showWinnerDialog.value = false;
  // ÈáçÁΩÆÂä®ÁîªÁä∂ÊÄÅÔºå‰ΩÜ‰øùÊåÅÂΩìÂâçÂ•ñÈ°π‰∏çÂèò
  setTimeout(() => {
    showWinnerNames.value = false;
    currentWinners.value = [];
    rollingNames.value = [];
    isSlowingDown.value = false;
  }, 300);
};

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
onUnmounted(() => {
  if (rollingTimer.value) {
    clearTimeout(rollingTimer.value);
  }
  document.removeEventListener('keydown', handleKeyPress);
  
  // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÊí≠Êîæ
  try {
    processAudio.pause();
    endAudio.pause();
  } catch (error) {
    console.warn('ÂÅúÊ≠¢Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
  }
});

const showWinners = async () => {
  if (!currentAward.value) {
    ElMessage.warning('ËØ∑ÂÖàÈÄâÊã©Â•ñÈ°π');
    return;
  }
  
  try {
    // Ë∞ÉËØï‰ø°ÊÅØÔºöÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
    console.log('=== showWinners Ë∞ÉËØï‰ø°ÊÅØ ===');
    console.log('currentAward:', currentAward.value);
    console.log('currentEpoch:', currentEpoch.value);
    console.log('showWinnerDialogÂàùÂßãÂÄº:', showWinnerDialog.value);

    // Ëé∑ÂèñÂΩìÂâçËΩÆÊ¨°ÂΩìÂâçÂ•ñÈ°πÁöÑ‰∏≠Â•ñËÄÖ
    const winnersData = await lotteryAPI.getWinnersByAward(currentAward.value.id);
    console.log('winnersData',winnersData)
    if (winnersData && winnersData.length > 0) {
      // Á≠õÈÄâÂΩìÂâçËΩÆÊ¨°ÁöÑ‰∏≠Â•ñËÄÖ
      const currentRoundWinners = winnersData.filter(winner => winner.epoch === currentEpoch.value);
      
      if (currentRoundWinners.length > 0) {
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè
        currentWinners.value = currentRoundWinners.map(winner => ({
          id: winner.id,
          name: winner.name,
          department: winner.department || 'Êú™Áü•ÈÉ®Èó®',
          award: winner.award,
          draw_time: winner.draw_time,
          epoch: winner.epoch
        }));
        // ÊòæÁ§∫‰∏≠Â•ñÂºπÁ™ó
        console.log('showWinnerDialog',showWinnerDialog.value)
        showWinnerDialog.value = true;
        console.log('showWinnerDialogËÆæÁΩÆÂêé:', showWinnerDialog.value);
      } else {
        console.log('ÂΩìÂâçËΩÆÊ¨°Êó†‰∏≠Â•ñËÄÖÔºåcurrentEpoch:', currentEpoch.value);
        ElMessage.info(`Á¨¨${currentEpoch.value}ËΩÆÂΩìÂâçÂ•ñÈ°πÊöÇÊó†‰∏≠Â•ñËÄÖ`);
      }
    } else {
      console.log('ËØ•Â•ñÈ°πÊöÇÊó†‰ªª‰Ωï‰∏≠Â•ñËÄÖ');
      ElMessage.info('ÂΩìÂâçÂ•ñÈ°πÊöÇÊó†‰∏≠Â•ñËÄÖ');
    }
  } catch (error) {
    console.error('Ëé∑Âèñ‰∏≠Â•ñËÄÖ‰ø°ÊÅØÂ§±Ë¥•:', error);
    ElMessage.error('Ëé∑Âèñ‰∏≠Â•ñËÄÖ‰ø°ÊÅØÂ§±Ë¥•');
  }
};

// ‰∏ã‰∏ÄËΩÆÊäΩÂ•ñ
const nextRound = async () => {
  try {
    const data = await lotteryAPI.nextRound();
    
    if (data.success) {
      // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
      ElMessage.success(data.message);
      
      // Êõ¥Êñ∞ËΩÆÊ¨°‰ø°ÊÅØ
      currentEpoch.value = data.currentEpoch;
      
      // ÈáçÊñ∞Ëé∑ÂèñÂ•ñÈ°πÊï∞ÊçÆÂíåÂèÇ‰∏éËÄÖÊï∞ÊçÆ
      await fetchAwards();
      await fetchParticipants();
      await fetchLotteryStatus();
      
      // ÈáçÁΩÆÊäΩÂ•ñÁä∂ÊÄÅÔºå‰ΩÜ‰øùÊåÅÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ•ñÈ°π
      if (awards.value.length > 0) {
        // Â¶ÇÊûúÂΩìÂâçÂ•ñÈ°πÁ¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥ÔºåÂàôÈáçÁΩÆ‰∏∫0
        if (currentIndex.value >= awards.value.length) {
          currentIndex.value = 0;
        }
        currentAward.value = awards.value[currentIndex.value] || awards.value[0];
        drawCount.value = currentAward.value?.draw_count || 1;
      }
      winners.value = [];
      currentWinners.value = [];
      isDrawing.value = false;
      isSlowingDown.value = false;
      showWinnerNames.value = false;
      rollingNames.value = [];
      showWinnerDialog.value = false;
    } else {
      ElMessage.error(data.error || 'ÂºÄÂßãÊñ∞ËΩÆÊ¨°Â§±Ë¥•');
    }
  } catch (error) {
    console.error('ÂºÄÂßãÊñ∞ËΩÆÊ¨°Â§±Ë¥•:', error);
    ElMessage.error('ÂºÄÂßãÊñ∞ËΩÆÊ¨°Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Ëé∑ÂèñÂ•ñÈ°πÊï∞ÊçÆ
onMounted(async () => {
  await fetchAwards();
  await fetchParticipants();
  await fetchLotteryStatus();
  await fetchSystemConfig();
});
</script>

<style scoped>
.el-dialog {
  border-radius: 8px;
}

.el-button {
  font-size: 16px;
  padding: 12px 24px;
}

.el-input-number {
  width: 120px;
  background: white;
  border-radius: 4px;
}

.custom-input-number :deep(.el-input__wrapper) {
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid #fbbf24 !important;
  border-radius: 6px !important;
}

.custom-input-number :deep(.el-input__inner) {
  color: #dc2626 !important;
  font-weight: 600 !important;
  text-align: center !important;
}

.custom-input-number :deep(.el-input-number__decrease),
.custom-input-number :deep(.el-input-number__increase) {
  background: #fbbf24 !important;
  border-color: #fbbf24 !important;
  color: #dc2626 !important;
  font-weight: bold !important;
}

.custom-input-number :deep(.el-input-number__decrease:hover),
.custom-input-number :deep(.el-input-number__increase:hover) {
  background: #f59e0b !important;
  border-color: #f59e0b !important;
}

:deep(.el-input-number__decrease),
:deep(.el-input-number__increase) {
  border-radius: 4px !important;
}

:deep(.el-table) {
  --el-table-header-bg-color: #f5f7fa;
  --el-table-row-hover-bg-color: #f5f7fa;
}
</style>