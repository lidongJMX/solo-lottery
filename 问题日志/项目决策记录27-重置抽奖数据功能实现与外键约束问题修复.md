# 项目决策记录27 - 重置抽奖数据功能实现与外键约束问题修复

## 问题描述

用户要求在管理页面增加一个重置抽奖数据的功能，包括：
- 重置参与者信息（清空中奖状态）
- 清空中奖信息
- 重置中奖信息
- 重置轮次信息

在实现过程中遇到了500内部服务器错误，经排查发现是数据库外键约束导致的问题。

## 技术分析

### 前端实现

1. **UI设计**：在系统设置页面添加了"危险操作"区域
   - 使用红色主题突出危险性
   - 添加详细的操作说明和警告信息
   - 实现二次确认机制

2. **功能特性**：
   - 双重确认对话框防止误操作
   - 加载状态显示
   - 操作完成后自动刷新数据
   - 详细的错误提示

### 后端问题修复

**问题根因**：SQLite数据库的外键约束阻止了Winner表的删除操作

**解决方案**：
1. 在重置操作前临时禁用外键约束：`PRAGMA foreign_keys = false`
2. 执行数据清理操作
3. 重新启用外键约束：`PRAGMA foreign_keys = true`
4. 添加异常处理确保外键约束始终被重新启用

## 实现细节

### 前端代码修改

1. **AdminPage.vue**：
   - 添加重置功能UI组件
   - 实现`resetLotteryData()`方法
   - 添加相应的CSS样式
   - 导入必要的图标组件

2. **重置流程**：
   ```javascript
   // 第一次确认
   await ElMessageBox.confirm(详细说明, '重置抽奖数据', options)
   
   // 第二次确认
   await ElMessageBox.confirm(最终确认, '最终确认', options)
   
   // 调用API
   await lotteryAPI.reset()
   
   // 刷新数据
   await Promise.all([fetchParticipants(), fetchAwards(), ...])
   ```

### 后端代码修改

**lottery.js**重置接口优化：
```javascript
router.post('/reset', async (req, res) => {
  try {
    // 临时禁用外键约束
    await dbRun('PRAGMA foreign_keys = false');
    
    // 清空中奖记录
    await dbRun('DELETE FROM Winner');
    
    // 重置奖项剩余数量
    await dbRun('UPDATE Award SET remaining_count = count');
    
    // 重置参与者中奖状态
    await dbRun('UPDATE Participant SET has_won = 0, win_count = 0, high_award_level = 100, updatedAt = ?', [currentTime]);
    
    // 重新启用外键约束
    await dbRun('PRAGMA foreign_keys = true');
    
    res.json({ message: '抽奖重置成功' });
  } catch (error) {
    // 异常处理和外键约束恢复
  }
});
```

## 关键修复点

1. **外键约束处理**：
   - 识别SQLite外键约束导致的删除失败
   - 使用PRAGMA语句临时控制外键约束
   - 确保异常情况下也能恢复外键约束

2. **数据一致性**：
   - 修正`high_award_level`字段重置值（从NULL改为100）
   - 确保所有相关表的数据都被正确重置

3. **用户体验**：
   - 双重确认防止误操作
   - 清晰的操作说明和警告
   - 详细的错误信息反馈

## 测试验证

重置功能应验证以下方面：
1. 所有中奖记录被清空
2. 参与者中奖状态被重置
3. 奖项剩余数量恢复到初始值
4. 操作后数据显示正确刷新
5. 异常情况下的错误处理

## 安全考虑

1. **权限控制**：重置功能仅在管理页面可用
2. **操作确认**：双重确认机制防止误操作
3. **数据备份**：建议在重置前提醒用户备份重要数据
4. **日志记录**：后端记录重置操作日志

## 后续优化建议

1. 考虑添加数据备份功能
2. 实现选择性重置（如只重置某个奖项）
3. 添加操作审计日志
4. 考虑实现撤销功能（在一定时间内）

## 影响范围

- **前端**：AdminPage.vue组件
- **后端**：lottery.js路由文件
- **数据库**：Winner、Award、Participant表
- **用户体验**：管理员操作流程