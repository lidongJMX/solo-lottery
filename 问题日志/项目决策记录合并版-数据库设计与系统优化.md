# 项目决策记录合并版 - 数据库设计与系统优化

## 概述
本文档合并了项目中关于数据库设计、系统架构优化、功能开发和技术问题修复的相关决策记录，涵盖了从数据库重构到功能完善的全过程。

---

## 一、数据库设计与重构 (记录23-26)

### 1.1 数据库结构重新设计 (记录23)
**设计背景**: 原有数据库结构过于简单，无法满足复杂抽奖系统需求

**新数据库表结构**:
1. **管理员表 (Admins)**: 存储系统管理员账户信息
2. **奖项表 (Awards)**: 存储奖项信息，支持等级和数量管理
3. **轮次表 (Epoches)**: 支持多轮次抽奖管理
4. **参与者表 (Participants)**: 存储人员信息，支持权重和中奖统计
5. **中奖记录表 (Winners)**: 存储中奖信息，关联参与者和奖项

**技术特点**:
- 外键约束管理，确保数据完整性
- 默认数据初始化，包含管理员账户和示例数据
- 数据类型优化，使用VARCHAR替代TEXT提高性能
- 统一使用ISO格式的DATETIME

### 1.2 数据库表结构优化 (记录24)
**问题**: 存在重复表结构，命名不统一
**解决方案**:
- 删除重复表，统一表名规范
- 所有表名改为单数形式且首字母大写
- 优化表结构，合并相关字段

**最终表结构**:
- **Admin**: 管理员表
- **Award**: 奖项表  
- **Epoch**: 轮次表
- **Participant**: 参与者表
- **Winner**: 中奖记录表

### 1.3 术语标准化 (记录25)
**标准化内容**: 将项目中的"奖品"统一改为"奖项"
**影响范围**: 前端UI、后端API、错误消息、代码注释
**实施效果**: 提高了项目的专业性和一致性

### 1.4 变量名统一 (记录26)
**统一规范**: 将"award"变量名修改为"award"
**修改范围**:
- 后端路由文件变量命名
- 前端组件变量命名
- CSS类名命名
- 对象属性命名

**变量对照表**:
| 原变量名 | 新变量名 |
|----------|----------|
| award | award |
| newaward | newAward |
| updatedaward | updatedAward |
| .award-card | .award-card |

---

## 二、功能开发与完善 (记录27-29、37)

### 2.1 参与者列表分页功能 (记录27)
**功能需求**: 为参与者列表添加分页功能，优化大数据量显示
**实现特点**:
- 支持每页数量选择（10, 20, 50, 100）
- 页码切换和跳转功能
- 编辑删除按钮同行显示
- 响应式设计适配

**技术实现**:
```javascript
const paginatedParticipants = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return participants.value.slice(start, end)
})
```

### 2.2 编辑和删除功能完善 (记录28)
**功能完善**:
1. **编辑参与者功能**: 新增编辑对话框，支持姓名、部门、联系方式编辑
2. **编辑奖项功能**: 完善奖项编辑，支持动态标题显示
3. **代码结构优化**: 提取公共方法，统一错误处理

**新增响应式数据**:
```javascript
const showEditParticipantDialog = ref(false)
const isEditingAward = ref(false)
const editingAwardId = ref(null)
const editingParticipant = ref({
  id: null, name: '', department: '', phone: '', email: ''
})
```

### 2.3 奖项管理列表简化 (记录29)
**简化原则**: 专注核心功能，移除复杂特性
**移除功能**:
- 搜索和筛选功能
- 批量操作功能
- 排序和分页功能
- 复制、详情等额外操作

**保留功能**:
- 添加、编辑、删除奖项
- 基本表格展示
- 奖项等级标签显示

### 2.4 参与者名单导入功能 (记录37)
**功能特性**:
- 支持Excel (.xlsx, .xls) 和CSV文件
- 文件大小限制5MB
- 支持中英文列名识别
- 重复数据检测和跳过
- 详细的导入结果反馈

**技术实现**:
- 后端使用multer处理文件上传
- 使用xlsx库解析Excel文件
- 前端实现拖拽上传和进度显示
- 批量数据库插入优化

**支持字段**:
- name（姓名）- 必填
- user_id（工号/员工号）- 可选
- department（部门）- 可选

---

## 三、技术问题修复 (记录31-36)

### 3.1 奖项管理功能修复 (记录31)
**问题**: 添加和编辑奖项时缺少draw_count字段处理
**修复内容**:
1. **前端修复**: 添加draw_count字段验证和API调用
2. **后端修复**: 完善draw_count字段的处理逻辑
3. **等级显示修复**: 修改标签类型处理数字等级

**验证规则**:
- draw_count必须大于0
- draw_count不能超过奖项总数量
- 所有必填字段都必须提供

### 3.2 服务端口占用问题解决 (记录32-33)
**问题**: 后端服务启动时端口8080被占用
**解决方案**:
1. **诊断问题**: 使用netstat查找占用进程
2. **终止进程**: 使用PowerShell强制终止占用进程
3. **重启服务**: 成功启动后端服务

**技术细节**:
```bash
# 查找占用进程
netstat -ano | findstr :8080
# 终止进程
powershell "Stop-Process -Id PID -Force"
# 重启服务
npm start
```

### 3.3 数据类型不匹配修复 (记录33)
**问题**: 前端奖项等级字段传递字符串，后端期望整数
**修复方案**:
```vue
<!-- 修改前 -->
<el-option label="1" value="1" />
<!-- 修改后 -->
<el-option label="1" :value="1" />
```

### 3.4 数据来源验证 (记录34)
**验证目的**: 确认奖项列表数据完全来自数据库
**验证结果**: ✅ 完全符合要求

**数据流向**:
1. **数据库** → SQLite Award表存储
2. **后端API** → `/awards`端点查询返回JSON
3. **前端API** → `awardAPI.getAll()`调用接口
4. **前端组件** → `fetchAwards()`更新界面
5. **用户界面** → 表格显示数据库原始数据

### 3.5 数据库dbRun函数修复 (记录36)
**问题**: dbRun函数无法访问lastID属性
**根本原因**: util.promisify无法正确处理需要访问this上下文的回调函数

**修复方案**:
```javascript
// 修改前
export const dbRun = promisify(db.run.bind(db));

// 修改后
export const dbRun = (sql, params = []) => {
  return new Promise((resolve, reject) => {
    db.run(sql, params, function(err) {
      if (err) {
        reject(err);
      } else {
        resolve({ lastID: this.lastID, changes: this.changes });
      }
    });
  });
};
```

**技术要点**:
- 使用自定义Promise包装替代util.promisify
- 保留sqlite3回调函数的this上下文
- 正确返回包含lastID和changes的对象
- 保持向后兼容性

---

## 四、技术架构总结

### 4.1 数据库架构
**数据库**: SQLite
**表设计**: 5个核心表，完整的关系约束
**数据类型**: 优化的字段类型，提高查询性能
**初始化**: 自动创建表结构和默认数据

### 4.2 后端架构
**框架**: Express.js
**路由**: 模块化设计，RESTful API
**数据库操作**: 自定义Promise包装，支持事务
**文件处理**: multer + xlsx，支持多格式导入

### 4.3 前端架构
**框架**: Vue 3 + Composition API
**UI库**: Element Plus
**状态管理**: ref/reactive本地状态
**API调用**: 统一的axios封装

### 4.4 开发工具链
**包管理**: npm
**开发服务器**: Vite (前端) + nodemon (后端)
**代码规范**: 统一的命名规范和代码结构

---

## 五、性能优化

### 5.1 数据库优化
- 使用VARCHAR替代TEXT提高查询性能
- 合理的索引设计和外键约束
- 批量插入优化，减少数据库连接

### 5.2 前端优化
- 分页显示减少DOM渲染压力
- 计算属性缓存，避免重复计算
- 组件懒加载和按需引入

### 5.3 文件处理优化
- 内存存储避免磁盘IO
- 文件大小限制防止内存溢出
- 流式处理大文件

---

## 六、安全考虑

### 6.1 文件上传安全
- 严格的文件类型验证
- 文件大小限制
- 内存存储避免文件残留

### 6.2 数据库安全
- 参数化查询防止SQL注入
- 事务处理保证数据一致性
- 错误信息过滤避免信息泄露

### 6.3 API安全
- 统一的错误处理
- 输入数据验证
- 适当的HTTP状态码使用

---

## 七、测试策略

### 7.1 功能测试
- 数据库CRUD操作测试
- 文件导入功能测试
- 分页和搜索功能测试
- 错误处理测试

### 7.2 性能测试
- 大数据量处理测试
- 并发操作测试
- 内存使用监控

### 7.3 兼容性测试
- 不同文件格式测试
- 浏览器兼容性测试
- 移动端适配测试

---

## 八、后续优化建议

### 8.1 功能扩展
1. **权限管理**: 添加角色和权限控制系统
2. **数据分析**: 添加统计图表和数据分析功能
3. **导出功能**: 支持多格式数据导出
4. **审计日志**: 记录所有操作历史
5. **实时通知**: WebSocket实时消息推送

### 8.2 技术升级
1. **TypeScript**: 引入类型安全
2. **单元测试**: 完善测试覆盖率
3. **CI/CD**: 自动化部署流水线
4. **监控告警**: 系统监控和性能告警
5. **缓存策略**: Redis缓存优化

### 8.3 用户体验
1. **响应式优化**: 更好的移动端体验
2. **国际化**: 多语言支持
3. **主题定制**: 可配置的UI主题
4. **快捷键**: 键盘快捷操作支持
5. **离线支持**: PWA离线功能

---

## 九、影响范围总结

### 9.1 数据库层面
- 完整的表结构重设计
- 数据完整性约束建立
- 性能优化和索引设计

### 9.2 后端API层面
- RESTful接口规范化
- 错误处理机制完善
- 文件处理功能新增

### 9.3 前端界面层面
- 管理功能界面完善
- 用户交互体验优化
- 响应式设计实现

### 9.4 系统架构层面
- 模块化设计实现
- 代码规范统一
- 开发工具链优化

---

## 十、状态总结

| 记录编号 | 功能模块 | 状态 | 完成时间 |
|---------|---------|------|----------|
| 记录23 | 数据库结构重设计 | ✅ 已完成 | 2024-12-19 |
| 记录24 | 数据库表结构优化 | ✅ 已完成 | 2024-12-19 |
| 记录25 | 术语标准化 | ✅ 已完成 | 2024-12-19 |
| 记录26 | 变量名统一 | ✅ 已完成 | 2024-12-19 |
| 记录27 | 参与者列表分页 | ✅ 已完成 | 2024-12-19 |
| 记录28 | 编辑删除功能完善 | ✅ 已完成 | 2024-12-19 |
| 记录29 | 奖项管理列表简化 | ✅ 已完成 | 2024-12-19 |
| 记录31 | 奖项管理功能修复 | ✅ 已完成 | 2024-12-19 |
| 记录32 | 端口占用问题解决 | ✅ 已完成 | 2024-12-19 |
| 记录33 | 数据类型不匹配修复 | ✅ 已完成 | 2024-12-19 |
| 记录34 | 数据来源验证 | ✅ 已完成 | 2024-12-19 |
| 记录36 | dbRun函数修复 | ✅ 已完成 | 2024-12-19 |
| 记录37 | 参与者导入功能 | ✅ 已完成 | 2024-12-19 |

**总体状态**: 所有功能已完成，系统架构完善，数据库设计合理，技术问题已解决。

---

**文档创建时间**: 2024-12-19  
**合并记录数量**: 13个  
**涵盖功能**: 数据库设计、系统架构、功能开发、技术修复  
**技术栈**: Vue 3 + Element Plus + Express.js + SQLite + multer + xlsx