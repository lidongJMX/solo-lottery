# Solo Lottery 抽奖系统规则文档

## 文档说明
本文档基于Solo Lottery抽奖系统的实际代码实现，整理了系统当前使用的完整抽奖规则。文档内容与系统实际运行逻辑保持一致，为用户和管理员提供准确的规则参考。

---

## 一、系统概述

### 1.1 系统定位
Solo Lottery是一个公平、智能的多轮抽奖系统，采用分层抽奖算法确保所有参与者都有公平的中奖机会，同时通过多重限制机制避免少数人重复中奖的情况。

### 1.2 核心特性
- **公平性保障**：全覆盖机制优先确保未中奖者有机会中奖
- **智能化分配**：动态概率调整，根据历史中奖情况分配中奖机会
- **多重限制**：通过次数、等级、轮次等多维度限制确保公平
- **透明可追溯**：完整记录抽奖过程，支持结果查询和验证

---

## 二、参与者资格与分类

### 2.1 基础参与者
- **定义**：所有未中过奖的员工
- **参与权重**：基础权重为100%
- **参与条件**：无特殊限制，自动包含在每轮抽奖池中

### 2.2 返场参与者
- **定义**：从最近两轮的中奖者中随机抽取20%的人员
- **选择机制**：系统自动随机选择，无人工干预
- **参与权重**：根据中奖历史动态调整（详见概率计算规则）

### 2.3 参与者池构成
每轮抽奖的参与者池包括：
1. **所有未中奖者**（100%参与）
2. **上两轮中奖者的20%**（随机选择）

---

## 三、中奖限制规则

### 3.1 总次数限制
- **普通员工**：最多可中奖3次
- **达到上限后**：将不再参与后续任何轮次的抽奖

### 3.2 奖项等级限制
- **一等奖、二等奖限制**：已获得一等奖或二等奖的员工，不能再次参与一等奖、二等奖的抽奖
- **三等奖及以下**：无特殊等级限制，但仍受总次数限制约束

### 3.3 轮次限制
- **同轮次限制**：在同一轮抽奖中，同一奖项不能重复抽取
- **当轮已中奖限制**：当轮已中奖的员工，不能在该轮次中再次中奖

### 3.4 概率权重限制
系统根据以下因素动态调整参与者的中奖概率：
- **中奖次数影响**：每次中奖减少30%权重（权重 × 0.7）
- **中奖等级影响**：等级越高（数值越小）权重越低
  - 一等奖获得者：权重 × 0.125（0.5³）
  - 二等奖获得者：权重 × 0.25（0.5²）
  - 三等奖获得者：权重 × 0.5
- **最小权重保障**：确保最小权重为1，保证每个符合条件的参与者都有中奖可能

---

## 四、特殊机制

### 4.1 全员中奖机制
**触发条件**：当剩余的奖品数量大于或等于尚未中奖的员工总数时，系统将启动"全员中奖"模式。

**执行策略**：
- **优先保障**：优先确保所有未中奖的员工都能获得奖品
- **选择逻辑**：在全员中奖模式下，系统会优先从未中奖员工中选择中奖者
- **兜底机制**：当未中奖员工全部中奖后，再按正常概率权重从返场参与者中选择

### 4.2 概率权重计算
系统使用加权随机算法进行抽奖：

```
基础权重 = 100
最终权重 = 基础权重 × 中奖次数系数 × 中奖等级系数

中奖次数系数 = 0.7^中奖次数
中奖等级系数 = 0.5^(4-最高中奖等级) （仅当最高等级≤3时）
```

**示例计算**：
- 未中奖员工：权重 = 100
- 中奖1次三等奖：权重 = 100 × 0.7 × 0.5 = 35
- 中奖2次二等奖：权重 = 100 × 0.7² × 0.5² = 12.25
- 中奖3次一等奖：权重 = 100 × 0.7³ × 0.5³ = 4.29

---

## 五、抽奖执行流程

### 5.1 准备阶段
1. **获取当前轮次**：系统自动获取当前抽奖轮次信息
2. **验证奖项状态**：检查选中奖项是否存在且有剩余数量
3. **验证抽取数量**：确保抽取数量在合理范围内

### 5.2 构建参与者池
1. **获取基础参与者**：查询所有未中奖的员工
2. **获取返场参与者**：从最近两轮中奖者中随机选择20%
3. **合并参与者池**：将基础参与者和返场参与者合并

### 5.3 筛选符合条件的参与者
系统会自动排除以下不符合条件的参与者：
- 已达到中奖次数上限（3次）的员工
- 已获得一等奖或二等奖且当前抽取一等奖或二等奖的员工
- 当轮已中奖的员工
- 已获得当前奖项的员工

### 5.4 执行抽奖
1. **检查全员中奖模式**：判断是否触发全员中奖机制
2. **按权重随机选择**：
   - 全员中奖模式：优先选择未中奖员工
   - 正常模式：按概率权重进行加权随机选择
3. **避免重复选择**：已选中的参与者从候选池中移除

### 5.5 更新系统状态
1. **记录中奖信息**：在Winner表中插入中奖记录
2. **更新参与者状态**：更新参与者的中奖次数和最高奖项等级
3. **更新奖项剩余数量**：减少对应奖项的剩余数量
4. **事务保障**：所有更新操作在数据库事务中执行，确保数据一致性

---

## 六、数据结构说明

### 6.1 核心数据表
- **Participant（参与者表）**：存储员工基本信息和中奖统计
- **Award（奖项表）**：存储奖项信息和剩余数量
- **Winner（中奖记录表）**：存储所有中奖记录
- **Epoch（轮次表）**：存储抽奖轮次信息

### 6.2 关键字段说明
**Participant表关键字段**：
- `has_won`：是否已中奖（0/1）
- `win_count`：中奖次数
- `high_award_level`：最高中奖等级
- `weight`：参与者权重（默认1.0）

**Award表关键字段**：
- `level`：奖项等级（1=一等奖，2=二等奖，3=三等奖）
- `count`：奖项总数量
- `remaining_count`：剩余数量
- `draw_count`：每次抽取数量

---

## 七、系统保障机制

### 7.1 数据完整性保障
- **外键约束**：确保中奖记录与参与者、奖项的关联完整性
- **事务处理**：所有关键操作使用数据库事务，确保原子性
- **数据同步**：参与者状态与中奖记录实时同步

### 7.2 公平性保障
- **算法透明**：抽奖算法完全基于数学概率，无人工干预
- **过程可追溯**：完整记录每次抽奖的参与者、时间、结果
- **多重验证**：多层次的条件检查确保规则执行的准确性

### 7.3 异常处理
- **边界检查**：对所有输入参数进行有效性验证
- **错误回滚**：操作失败时自动回滚，保持数据一致性
- **日志记录**：详细记录系统运行日志，便于问题排查

---

## 八、使用注意事项

### 8.1 管理员操作
- **奖项配置**：确保奖项信息准确，特别是等级和数量设置
- **参与者管理**：及时更新参与者信息，确保数据准确性
- **轮次管理**：合理控制抽奖轮次，避免过度集中

### 8.2 抽奖操作
- **网络稳定**：确保网络连接稳定，避免抽奖过程中断
- **数据备份**：重要抽奖前建议备份数据库
- **结果确认**：抽奖完成后及时确认结果，必要时可撤销重抽

### 8.3 结果查询
- **实时查询**：系统支持实时查询中奖记录和统计信息
- **数据导出**：支持将中奖记录导出为Excel格式
- **历史追溯**：可查询历史轮次的完整抽奖记录

---

## 九、技术支持

### 9.1 常见问题
1. **Q：为什么某些员工无法参与抽奖？**
   A：可能已达到中奖次数上限或不符合当前奖项的参与条件。

2. **Q：如何确保抽奖结果的公平性？**
   A：系统使用数学概率算法，所有过程透明可追溯，无人工干预。

3. **Q：可以撤销抽奖结果吗？**
   A：支持撤销功能，但建议谨慎使用，撤销后会恢复相关数据状态。

### 9.2 系统维护
- **定期备份**：建议定期备份数据库，确保数据安全
- **性能监控**：关注系统性能，必要时进行优化
- **版本更新**：及时关注系统更新，获取新功能和修复

---

## 十、版本信息

- **文档版本**：v1.0
- **系统版本**：基于Solo Lottery当前版本
- **更新日期**：2024年12月
- **维护人员**：系统管理员

---

**注意**：本文档基于系统实际代码实现编写，如系统功能有更新，请及时更新本文档以保持一致性。