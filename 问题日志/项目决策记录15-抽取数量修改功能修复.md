# 项目决策记录15 - 抽取数量修改功能修复

## 问题描述
用户在抽奖页面修改当前奖项的抽取数量时，出现400错误：
```
PUT http://localhost:8080/api/awards/1 400 (Bad Request)
更新抽取数量失败: AxiosError
```

## 问题分析

### 根本原因
1. **前端数据绑定问题**：`drawCount`被定义为computed属性，但在模板中使用`v-model="drawCount"`进行双向绑定，这是不正确的
2. **API请求数据不完整**：前端在调用更新API时，缺少必需的`level`字段，导致后端验证失败

### 技术细节
- 后端API `/api/awards/:id` PUT请求要求`level`、`name`、`count`字段为必需
- 前端`updateDrawCount`方法只发送了`name`、`description`、`count`、`draw_count`字段
- `drawCount`作为computed属性无法用于双向绑定

## 解决方案

### 1. 修复数据绑定问题
```javascript
// 修改前：computed属性
const drawCount = computed(() => currentAward.value?.draw_count || 1);

// 修改后：ref响应式变量
const drawCount = ref(1);
```

### 2. 同步数据更新
在以下场景中确保`drawCount`与`currentAward.draw_count`同步：
- `selectAward`：切换奖项时同步
- `fetchAwards`：获取数据后初始化
- 默认数据设置时初始化

### 3. 修复API请求数据
```javascript
// 修改前：缺少level字段
const updateData = {
  name: currentAward.value.name,
  description: currentAward.value.description,
  count: currentAward.value.count,
  draw_count: newValue
};

// 修改后：包含所有必需字段
const updateData = {
  level: currentAward.value.level,
  name: currentAward.value.name,
  description: currentAward.value.description,
  count: currentAward.value.count,
  draw_count: newValue
};
```

## 技术实现

### 修改的文件
- `frontend/src/components/LotteryPage.vue`

### 关键修改点
1. **数据定义**：将`drawCount`从computed改为ref
2. **数据同步**：在`selectAward`、`fetchAwards`等方法中同步`drawCount`值
3. **API请求**：在`updateDrawCount`方法中添加`level`字段

### 代码变更
```javascript
// 1. 数据定义修改
const drawCount = ref(1);

// 2. 奖项切换时同步
const selectAward = (index) => {
  currentIndex.value = index;
  currentAward.value = awards.value[index];
  drawCount.value = currentAward.value?.draw_count || 1;
};

// 3. 数据获取后初始化
if (awards.value.length > 0) {
  currentAward.value = awards.value[0];
  drawCount.value = currentAward.value?.draw_count || 1;
}

// 4. API请求数据完整性
const updateData = {
  level: currentAward.value.level,
  name: currentAward.value.name,
  description: currentAward.value.description,
  count: currentAward.value.count,
  draw_count: newValue
};
```

## 功能验证

### 验证要点
1. **数据绑定**：输入框能正确显示和修改抽取数量
2. **奖项切换**：切换奖项时抽取数量正确同步
3. **API调用**：修改抽取数量时不再出现400错误
4. **数据持久化**：修改后的数量能正确保存到数据库
5. **界面同步**：本地数据与服务器数据保持一致

### 测试场景
- 修改当前奖项的抽取数量
- 切换到其他奖项再切换回来，验证数量是否保持
- 刷新页面后验证数量是否正确加载
- 验证数量范围限制（1到奖项总数之间）

## 影响分析

### 正面影响
1. **功能恢复**：抽取数量修改功能正常工作
2. **用户体验**：用户可以灵活调整每次抽奖的人数
3. **数据一致性**：前后端数据保持同步
4. **代码质量**：修复了不正确的数据绑定方式

### 风险控制
1. **向后兼容**：修改不影响现有功能
2. **数据安全**：保持原有的数据验证逻辑
3. **错误处理**：保留完整的错误处理机制

## 优化建议

### 短期优化
1. **输入验证**：在前端添加实时输入验证
2. **用户反馈**：优化错误提示信息的用户友好性
3. **性能优化**：减少不必要的API调用

### 长期优化
1. **状态管理**：考虑使用Vuex或Pinia统一管理奖项状态
2. **类型安全**：引入TypeScript提升代码质量
3. **测试覆盖**：添加单元测试和集成测试

---

## 总结
通过修复数据绑定问题和API请求数据完整性，成功解决了抽取数量修改功能的400错误。这次修复不仅解决了当前问题，还提升了代码的健壮性和用户体验。修改后的功能能够正确处理抽取数量的修改、同步和持久化，为用户提供了灵活的抽奖配置能力。

**状态**: ✅ 已完成
**优先级**: 高
**影响范围**: 前端抽奖页面功能