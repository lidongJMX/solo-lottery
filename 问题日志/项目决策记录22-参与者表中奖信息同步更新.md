# 项目决策记录22-参与者表中奖信息同步更新

## 问题描述
在抽奖系统中发现参与者表（Participant）的中奖信息没有与中奖记录表（Winner）保持同步：
- 抽奖时只在Winner表记录中奖信息，但没有更新Participant表的has_won、win_count、high_award_level字段
- 重置抽奖时只清空Winner表，但没有重置Participant表的中奖状态
- 删除中奖记录时只删除Winner表记录，但没有重新计算Participant表的中奖统计

这导致参与者的中奖状态信息不准确，影响抽奖权重计算和统计功能。

## 解决方案
在所有涉及中奖记录变更的操作中，同步更新参与者表的中奖信息：

### 1. 抽奖接口（draw）
在记录中奖信息后，同步更新参与者的中奖状态：
```javascript
// 获取参与者当前的中奖统计
const participantStats = await dbGet(
  'SELECT win_count, high_award_level FROM Participant WHERE id = ?',
  [selectedParticipant.id]
);

const newWinCount = (participantStats.win_count || 0) + 1;
const currentHighLevel = participantStats.high_award_level || 999;
const newHighLevel = Math.min(currentHighLevel, award.level);

// 更新参与者的中奖状态
await dbRun(
  'UPDATE Participant SET has_won = 1, win_count = ?, high_award_level = ?, updatedAt = ? WHERE id = ?',
  [newWinCount, newHighLevel, currentTime, selectedParticipant.id]
);
```

### 2. 重置接口（reset）
在清空中奖记录后，重置所有参与者的中奖状态：
```javascript
// 重置所有参与者的中奖状态
const currentTime = new Date().toISOString();
await dbRun(
  'UPDATE Participant SET has_won = 0, win_count = 0, high_award_level = NULL, updatedAt = ?',
  [currentTime]
);
```

### 3. 删除中奖记录接口（delete /winners/:winnerId）
在删除中奖记录后，重新计算该参与者的中奖统计：
```javascript
// 重新计算该参与者的中奖统计
const participantWins = await dbAll(
  `SELECT w.*, a.level FROM Winner w 
   JOIN Award a ON w.award_id = a.id 
   WHERE w.participant_id = ? 
   ORDER BY a.level ASC`,
  [winner.participant_id]
);

if (participantWins.length === 0) {
  // 该参与者已无中奖记录，重置为未中奖状态
  await dbRun(
    'UPDATE Participant SET has_won = 0, win_count = 0, high_award_level = NULL, updatedAt = ? WHERE id = ?',
    [currentTime, winner.participant_id]
  );
} else {
  // 重新计算中奖统计
  const newWinCount = participantWins.length;
  const newHighLevel = Math.min(...participantWins.map(w => w.level));
  
  await dbRun(
    'UPDATE Participant SET has_won = 1, win_count = ?, high_award_level = ?, updatedAt = ? WHERE id = ?',
    [newWinCount, newHighLevel, currentTime, winner.participant_id]
  );
}
```

## 技术细节
- **数据一致性**：确保Participant表和Winner表的数据始终保持同步
- **中奖统计计算**：
  - `has_won`：是否中过奖（0/1）
  - `win_count`：中奖次数
  - `high_award_level`：最高中奖等级（数值越小等级越高）
- **事务安全**：所有更新操作在同一个事务中执行，确保数据一致性

## 影响范围
- 后端API：lottery.js中的draw、reset、delete接口
- 数据完整性：参与者中奖状态信息的准确性
- 抽奖逻辑：基于准确的中奖统计进行权重计算
- 统计功能：提供准确的参与者中奖数据

## 验证方法
1. 执行抽奖后，检查中奖者在Participant表中的has_won、win_count、high_award_level字段是否正确更新
2. 执行重置操作后，检查所有参与者的中奖状态是否被正确重置
3. 删除中奖记录后，检查对应参与者的中奖统计是否被正确重新计算
4. 验证多次中奖的参与者统计信息是否准确

## 修改时间
2024年1月

## 修改人员
AI助手

## 备注
这次修复确保了参与者表中奖信息的实时同步，提高了数据一致性和系统可靠性，为准确的抽奖权重计算和统计功能提供了基础。