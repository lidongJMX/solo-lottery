# 项目决策记录21-轮次获取逻辑修复

## 问题描述
在抽奖系统中发现轮次获取逻辑存在不一致的问题：
- draw接口中使用 `SELECT COALESCE(MAX(epoch), 0) as current_epoch FROM Winner` 从Winner表获取当前轮次
- next-round接口和status接口中使用 `SELECT * FROM Epoch ORDER BY epoch_id DESC LIMIT 1` 从Epoch表获取当前轮次

这种不一致导致轮次信息可能不准确，特别是在没有中奖记录或轮次管理不同步的情况下。

## 解决方案
统一轮次获取逻辑，所有接口都从Epoch表获取当前轮次信息：

### 修改内容
1. **修改draw接口中的轮次获取逻辑**：
   - 原代码：`const currentEpoch = await dbGet('SELECT COALESCE(MAX(epoch), 0) as current_epoch FROM Winner');`
   - 修改为：`const currentEpochInfo = await dbGet('SELECT * FROM Epoch ORDER BY epoch_id DESC LIMIT 1');`
   - 轮次值获取：`const epoch = currentEpochInfo ? currentEpochInfo.epoch : 1;`

2. **同时修复了抽奖数量验证逻辑**：
   - 移除了硬编码的1-10限制
   - 改为根据奖项实际总数量和剩余数量进行验证
   - 提供更准确的错误提示信息

## 技术细节
- **数据源统一**：所有轮次相关操作都基于Epoch表
- **容错处理**：当Epoch表为空时，默认轮次为1
- **一致性保证**：确保轮次管理在整个系统中的一致性

## 影响范围
- 后端API：lottery.js中的draw接口
- 轮次管理：确保轮次信息的准确性
- 抽奖逻辑：基于正确的轮次进行参与者筛选和权重计算

## 验证方法
1. 启动新一轮抽奖后，检查draw接口获取的轮次是否正确
2. 确认抽奖过程中轮次信息的一致性
3. 验证抽奖数量验证逻辑是否正常工作

## 修改时间
2024年1月

## 修改人员
AI助手

## 备注
这次修复解决了轮次管理中的关键不一致问题，提高了系统的可靠性和数据准确性。