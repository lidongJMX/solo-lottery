# 项目决策记录37 - 参与者名单导入功能开发

## 日期
2024-12-19

## 问题描述
用户需要开发参与者列表的导入名单功能，支持从Excel和CSV文件中批量导入参与者信息。导入的表格字段包括：
- name（姓名）- 必填
- user_id（工号/员工号）- 可选
- department（部门）- 可选

## 解决方案

### 1. 后端API开发
- 在 `backend/src/routes/participants.js` 中添加了批量导入接口 `/api/participants/import`
- 使用 `multer` 处理文件上传，支持内存存储
- 使用 `xlsx` 库解析Excel文件，支持CSV文件解析
- 添加文件类型验证和大小限制（5MB）
- 支持中英文列名识别
- 实现重复数据检测和错误处理

### 2. 依赖包更新
在 `backend/package.json` 中添加了新的依赖：
```json
"multer": "^1.4.5-lts.1",
"xlsx": "^0.18.5"
```

### 3. 前端API接口
在 `frontend/src/api/index.js` 中添加了导入接口：
```javascript
import(file) {
  const formData = new FormData()
  formData.append('file', file)
  return api.post('/participants/import', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

### 4. 前端UI实现
在 `AdminPage.vue` 中实现了完整的导入功能：
- 优化了导入对话框UI，添加了文件格式说明
- 实现了文件选择和上传功能
- 添加了导入进度显示和加载状态
- 实现了导入结果的详细反馈
- 导入成功后自动刷新参与者列表和统计数据

## 技术特性

### 文件格式支持
- Excel文件：.xlsx, .xls
- CSV文件：.csv
- 文件大小限制：5MB

### 列名识别
支持以下列名（不区分大小写）：
- 姓名：`name`, `姓名`
- 工号：`user_id`, `工号`, `员工号`
- 部门：`department`, `部门`

### 数据处理
- 自动过滤空行和无效数据
- 重复姓名检测和跳过
- 详细的错误报告和统计信息
- 批量插入优化

### 用户体验
- 拖拽上传支持
- 实时文件选择反馈
- 导入进度显示
- 详细的结果统计
- 错误信息展示

## 实现细节

### 后端处理流程
1. 文件上传验证（类型、大小）
2. 根据文件类型选择解析方式
3. 列名识别和数据提取
4. 数据验证和清洗
5. 重复检测
6. 批量数据库插入
7. 返回详细统计结果

### 前端处理流程
1. 文件选择和验证
2. 上传文件到后端
3. 显示导入进度
4. 处理导入结果
5. 刷新相关数据
6. 用户反馈

## 安全考虑
- 文件类型严格验证
- 文件大小限制
- 内存存储避免磁盘文件残留
- SQL注入防护
- 错误信息过滤

## 测试建议
1. 测试不同格式的Excel和CSV文件
2. 测试中英文列名识别
3. 测试重复数据处理
4. 测试大文件上传
5. 测试错误文件格式
6. 测试网络异常情况

## 后续优化
1. 可考虑添加导入预览功能
2. 支持更多文件格式
3. 添加导入模板下载
4. 优化大文件处理性能
5. 添加导入历史记录

## 影响范围
- 后端：新增导入API接口
- 前端：管理页面新增导入功能
- 数据库：无结构变更，仅数据新增
- 依赖：新增multer和xlsx包