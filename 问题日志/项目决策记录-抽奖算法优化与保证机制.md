# 项目决策记录 - 抽奖算法优化与保证机制

## 问题背景

用户询问如何在经过8轮抽奖后，完全保证中奖2次和3次的人数保持一定数量。通过分析现有测试结果发现：

### 当前算法问题
1. **中奖分布不均**：测试结果显示中奖次数分布为 `{0: 2660, 1: 2280, 2: 60, 3: 0}`
2. **目标未达成**：期望8%的三次中奖者和15%的二次中奖者，但实际只有1.2%的二次中奖者，0%的三次中奖者
3. **基尼系数过高**：平均0.54，表明分配不均严重
4. **随机性不足**：正态分布检验通过率为0

## 解决方案

### 1. 分阶段保证策略

#### 前5轮：正常模式（逐步引导）
- **未中奖者**：100%参与，保证基本公平
- **一次中奖者**：参与比例从30%逐步增加到80%，权重随轮次增加（2.0 + 进度比例 * 2.0）
- **二次中奖者**：参与比例从0%逐步增加到60%，权重随轮次增加（3.0 + 进度比例 * 3.0）

#### 第6-8轮：保证模式（强制达标）
- **计算缺口**：实时计算还需要多少二次和三次中奖者
- **保证中奖**：为需要达标的参与者设置超高权重（10.0-15.0）和保证中奖标记
- **优先选择**：抽奖算法优先选择保证中奖者
- **动态调整**：未中奖者参与比例随轮次递减（从70%到30%）

### 2. 核心算法改进

#### 多重中奖控制函数优化
```javascript
// 新增配置参数
guaranteeMode: true  // 启用保证模式

// 分阶段策略
if (activeConfig.guaranteeMode && currentEpoch >= 6) {
  // 保证模式逻辑
} else {
  // 正常模式逻辑
}
```

#### 选择算法优化
```javascript
// 优先选择保证中奖者
if (participant.guaranteedWin) {
  // 确定性选择，不依赖概率
  return selectedGuaranteedWinner;
}
```

### 3. 数据库结构更新

#### MultiWinConfig表新增字段
```sql
ALTER TABLE MultiWinConfig ADD COLUMN guaranteeMode TINYINT(1) NOT NULL DEFAULT 1;
```

#### 默认配置优化
- `threeWinPercentage`: 5% → 8%
- `twoWinPercentage`: 10% → 15%  
- `minEpochInterval`: 3 → 2
- `guaranteeMode`: 新增，默认启用

### 4. 实现细节

#### 权重机制
- **正常权重**：基础权重 * 多次中奖加成
- **保证权重**：超高权重（10.0-15.0）确保必中
- **动态调整**：权重随轮次进度动态增加

#### 参与者筛选
- **轮次间隔**：放宽到1轮（原3轮）
- **参与比例**：根据目标缺口动态调整
- **优先级**：保证中奖者 > 权重选择 > 随机选择

## 预期效果

### 1. 中奖分布改善
- **二次中奖者**：从1.2%提升到15%
- **三次中奖者**：从0%提升到8%
- **基尼系数**：预期降低到0.4以下

### 2. 公平性提升
- **保证达标**：确保目标人数在第8轮结束时达成
- **过程公平**：前期保持随机性，后期精准调控
- **透明机制**：所有调整都有明确的数学依据

### 3. 系统稳定性
- **兜底机制**：多层保证确保不会出现极端情况
- **可配置性**：管理员可调整目标比例和保证模式
- **监控能力**：实时统计和日志记录

## 技术实现

### 关键函数修改
1. `applyMultiWinControl()` - 实现分阶段策略
2. `selectByProbability()` - 支持保证中奖机制
3. 配置接口 - 支持guaranteeMode参数

### 测试验证
- 需要运行新的测试用例验证算法效果
- 监控8轮抽奖后的中奖分布是否达到目标
- 检查基尼系数和公平性指标的改善

## 风险评估

### 潜在风险
1. **过度干预**：保证模式可能影响抽奖的随机性感知
2. **性能影响**：复杂的权重计算可能影响响应速度
3. **配置复杂**：新增参数增加了系统配置的复杂度

### 缓解措施
1. **渐进式**：前期保持随机性，后期才启用保证模式
2. **优化算法**：使用高效的权重计算和选择算法
3. **默认配置**：提供合理的默认值，减少配置负担

## 决策记录

**决策时间**：2024年1月
**决策人**：AI助手
**决策依据**：测试数据分析和用户需求
**实施状态**：已完成代码实现，待测试验证

这个优化方案通过分阶段保证策略，在保持前期随机性的同时，确保最终目标的达成，是一个平衡公平性和确定性的有效解决方案。